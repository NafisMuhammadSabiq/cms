<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daftar Buku Perpustakaan</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #crudForm { display: none; border: 1px solid #ccc; padding: 15px; width: 300px; margin-bottom: 20px; }
    input, select { display: block; margin-bottom: 10px; width: 100%; padding: 5px; }
    button { padding: 5px 10px; margin-right: 5px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    .cover-preview { max-width: 100px; display: block; margin-top: 5px; }
  </style>
</head>
<body>
  <h2>Daftar Buku Perpustakaan</h2>
  <button onclick="showForm()">Tambah Buku</button>

  <form id="crudForm" onsubmit="saveData(event)">
    <input type="hidden" id="recordId" />
    <label>Judul:</label>
    <input type="text" id="judul" required />
    <label>Pengarang:</label>
    <input type="text" id="pengarang" required />
    <label>Penerbit:</label>
    <input type="text" id="penerbit" required />
    <label>Tanggal Terbit:</label>
    <input type="date" id="tanggalTerbit" required />
    <label>Genre:</label>
    <input type="text" id="genre" required />
    <label>Cover Buku:</label>
    <input type="file" id="coverInput" accept="image/*" />
    <img id="coverPreview" src="" class="cover-preview" />
    <button type="submit">Simpan</button>
    <button type="button" onclick="hideForm()">Batal</button>
    <button type="button" id="deleteBtn" onclick="deleteData()">Hapus</button>
  </form>

  <table id="dataTable">
    <thead>
      <tr>
        <th>Judul</th>
        <th>Pengarang</th>
        <th>Penerbit</th>
        <th>Tanggal</th>
        <th>Genre</th>
        <th>Cover</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    const supabaseUrl = 'https://whhnuismtwqbmplvwzwf.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndoaG51aXNtdHdxYm1wbHZ3endmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAxMzc1ODQsImV4cCI6MjA2NTcxMzU4NH0.9aAnrF1Vicqui3zWSXcAck_prcganeCIJEtN-RKyDVc'
    const supabase = createClient(supabaseUrl, supabaseKey)

    const crudForm = document.getElementById('crudForm')
    const recordIdInput = document.getElementById('recordId')
    const judulInput = document.getElementById('judul')
    const pengarangInput = document.getElementById('pengarang')
    const penerbitInput = document.getElementById('penerbit')
    const tanggalInput = document.getElementById('tanggalTerbit')
    const genreInput = document.getElementById('genre')
    const coverInput = document.getElementById('coverInput')
    const coverPreview = document.getElementById('coverPreview')
    const deleteBtn = document.getElementById('deleteBtn')
    const dataTableBody = document.querySelector('#dataTable tbody')

    coverInput.addEventListener('change', () => {
      const file = coverInput.files[0]
      if (file) {
        coverPreview.src = URL.createObjectURL(file)
      } else {
        coverPreview.src = ''
      }
    })

    function showForm(data = null) {
      if (data) {
        recordIdInput.value = data.id
        judulInput.value = data.judul
        pengarangInput.value = data.pengarang
        penerbitInput.value = data.penerbit
        tanggalInput.value = data.tanggal_terbit
        genreInput.value = data.genre
        coverPreview.src = data.cover_url || ''
        deleteBtn.style.display = 'inline-block'
      } else {
        recordIdInput.value = ''
        crudForm.reset()
        coverPreview.src = ''
        deleteBtn.style.display = 'none'
      }
      crudForm.style.display = 'block'
      judulInput.focus()
    }

    function hideForm() {
      crudForm.style.display = 'none'
    }

    async function loadData() {
      const { data, error } = await supabase.from('buku').select('*').order('id', { ascending: false })
      if (error) return alert('Gagal load data: ' + error.message)

      dataTableBody.innerHTML = ''
      data.forEach(row => {
        const tr = document.createElement('tr')
        tr.innerHTML = `
          <td>${row.judul}</td>
          <td>${row.pengarang}</td>
          <td>${row.penerbit}</td>
          <td>${row.tanggal_terbit}</td>
          <td>${row.genre}</td>
          <td><img src="${row.cover_url}" class="cover-preview"/></td>
          <td><button onclick='showForm(${JSON.stringify(row)})'>Edit</button></td>
        `
        dataTableBody.appendChild(tr)
      })
    }

    async function saveData(e) {
      e.preventDefault()
      const id = recordIdInput.value
      const judul = judulInput.value.trim()
      const pengarang = pengarangInput.value.trim()
      const penerbit = penerbitInput.value.trim()
      const tanggal_terbit = tanggalInput.value
      const genre = genreInput.value.trim()
      const coverFile = coverInput.files[0]
      let cover_url = ''
      let old_cover_url = coverPreview.src

      if (!judul || !pengarang || !penerbit || !tanggal_terbit || !genre) {
        return alert('Harap lengkapi semua field!')
      }

      if (coverFile) {
        const fileName = `${Date.now()}-${coverFile.name}`
        const { error: uploadError } = await supabase.storage
          .from('cover-buku')
          .upload(`cover/${fileName}`, coverFile)

        if (uploadError) return alert('Upload cover gagal: ' + uploadError.message)

        cover_url = `${supabaseUrl}/storage/v1/object/public/cover-buku/cover/${fileName}`
      } else if (id) {
        cover_url = old_cover_url
      }

      const dataToSave = { judul, pengarang, penerbit, tanggal_terbit, genre, cover_url }

      if (id) {
        const { error } = await supabase.from('buku').update(dataToSave).eq('id', id)
        if (error) return alert('Update gagal: ' + error.message)
      } else {
        const { error } = await supabase.from('buku').insert([dataToSave])
        if (error) return alert('Insert gagal: ' + error.message)
      }

      hideForm()
      loadData()
    }

    async function deleteData() {
      const id = recordIdInput.value
      if (!confirm('Yakin ingin menghapus buku ini?')) return
      const { error } = await supabase.from('buku').delete().eq('id', id)
      if (error) return alert('Gagal hapus: ' + error.message)
      hideForm()
      loadData()
    }

    loadData()
  </script>
</body>
</html>
